#!/bin/bash
# notat - Unified CLI for Notat.sh

# Resolve symlink to find the real location of the script
REAL_SCRIPT_PATH="$(readlink -f "$0")"
SCRIPT_DIR="$(dirname "$REAL_SCRIPT_PATH")"
export NOTES_SYSTEM_DIR="$(dirname "$SCRIPT_DIR")"

# Source the system
# We need to source config and functions. 
# Since this is bash, and the functions are zsh-compatible but mostly posix, 
# we need to be careful. Ideally, the functions should be POSIX compliant or we run this with zsh.
# Given the user uses zsh, we should probably execute this with zsh if possible, 
# or ensure the functions are bash compatible. 
# The functions use `local` which is supported in bash.
# They use `[[ ]]` which is supported in bash.
# They use `command -v` which is supported in bash.
# So bash should be fine.

source "$NOTES_SYSTEM_DIR/config.zsh"
for func in "$NOTES_SYSTEM_DIR/functions/"*.zsh; do
    source "$func"
done

usage() {
    # ANSI Colors
    local BOLD="\033[1m"
    local CYAN="\033[36m"
    local GREEN="\033[32m"
    local YELLOW="\033[33m"
    local RESET="\033[0m"

    echo -e "${BOLD}Usage:${RESET} notat <command> [args]"
    echo ""
    echo -e "${BOLD}Note Management${RESET}"
    echo -e "  n, new${RESET}      <type> [name]   Create a new note"
    echo -e "  s, search${RESET}   <type>          Search notes"
    echo -e "  p, pick${RESET}     <type>          Pick (find) a note file"
    echo -e "  r, review${RESET}   <type>          Review notes (looped search)"
    echo ""
    echo -e "${BOLD}Security & Environment${RESET}"
    echo -e "  env${RESET}         <cmd>           Manage environments (list, switch)"
    echo -e "  secure${RESET}      <cmd>           Manage encrypted vault (init, mount...)"
    echo -e "  setup${RESET}       [env] [--force] Onboarding wizard"
    echo -e "  backup${RESET}      [env]           Quick sync (publish encrypted vault)"
    echo ""
    echo -e "${BOLD}System${RESET}"
    echo -e "  theme${RESET}                       Select preview theme"
    echo -e "  stats${RESET}       [env]           Show statistics"
    echo -e "  doctor${RESET}                      Health check"
    echo -e "  help${RESET}                        Show this help"
    echo ""
    echo "Types:"
    echo "  daily, journal, people, resource, thought, action"
    echo ""
    echo "Use 'notat <command> --help' for more information on a command."
}


cmd="$1"
shift || cmd="help"

case "$cmd" in
    setup)
        note_setup "$@"
        ;;
    env)
        subcmd="$1"
        shift || { note_env_help; exit 1; }
        
        # Check for help flag
        if [[ "$subcmd" == "--help" || "$subcmd" == "-h" ]]; then
            note_env_help
            exit 0
        fi
        
        func="note_env_${subcmd}"
        if command -v "$func" &> /dev/null; then
            "$func" "$@"
        else
            echo "Error: Unknown env command '$subcmd'."
            note_env_help
            exit 1
        fi
        ;;
    secure)
        subcmd="$1"
        # If no subcommand, show help
        if [[ -z "$subcmd" ]]; then
             note_secure_help
             exit 1
        fi
        
        # Check for help flag
        if [[ "$subcmd" == "--help" || "$subcmd" == "-h" ]]; then
            note_secure_help
            exit 0
        fi
        
        shift
        func="note_secure_${subcmd}"
        if command -v "$func" &> /dev/null; then
            "$func" "$@"
        else
            echo "Error: Unknown secure command '$subcmd'."
            note_secure_help
            exit 1
        fi
        ;;
    new|n)
        type="$1"
        shift || { 
            echo "Error: Missing type."
            echo "Usage: notat new <type> [name]"
            echo "Available types: daily, journal, people, resource, thought, action"
            echo ""
            echo "Examples:"
            echo "  notat new daily"
            echo "  notat new action 'Fix bug'"
            exit 1
        }
        func="note_${type}_create"
        if command -v "$func" &> /dev/null; then
            "$func" "$@"
        else
            echo "Error: Unknown type '$type'."
            echo "Available types: daily, journal, people, resource, thought, action"
            exit 1
        fi
        ;;
    search|s)
        type="$1"
        shift || {
            echo "Error: Missing type."
            echo "Usage: notat search <type>"
            echo "Available types: daily, journal, people, resource, thought, action"
            exit 1
        }
        # Handle action-note special case
        if [[ "$type" == "action-note" ]]; then
            note_action_note_search "$@"
        else
            func="note_${type}_search"
            if command -v "$func" &> /dev/null; then
                "$func" "$@"
            else
                echo "Error: Unknown type '$type'."
                echo "Available types: daily, journal, people, resource, thought, action"
                exit 1
            fi
        fi
        ;;
    pick|p)
        type="$1"
        shift || {
            echo "Error: Missing type."
            echo "Usage: notat pick <type>"
            echo "Available types: daily, journal, people, resource, thought, action"
            exit 1
        }
        func="note_${type}_pick"
        if command -v "$func" &> /dev/null; then
            "$func" "$@"
        else
            echo "Error: Unknown type '$type'."
            echo "Available types: daily, journal, people, resource, thought, action"
            exit 1
        fi
        ;;
    review|r)
        type="$1"
        shift || {
            echo "Error: Missing type."
            echo "Usage: notat review <type>"
            echo "Available types: daily, journal, people, resource, thought, action"
            exit 1
        }
        # Handle action-note special case
        if [[ "$type" == "action-note" ]]; then
            note_action_note_review "$@"
        else
            func="note_${type}_review"
            if command -v "$func" &> /dev/null; then
                "$func" "$@"
            else
                echo "Error: Unknown type '$type'."
                echo "Available types: daily, journal, people, resource, thought, action"
                exit 1
            fi
        fi
        ;;
    theme)
        note_theme
        ;;
    backup)
        # Backup current environment (or specified environment)
        env="${1:-$(note_env_current)}"
        note_secure_publish "$env"
        ;;
    stats)
        note_stats
        ;;
    prune)
        note_prune
        ;;
    doctor|health)
        note_health
        ;;
    help|--help|-h)
        usage
        ;;
    *)
        echo "Error: Unknown command '$cmd'."
        usage
        exit 1
        ;;
esac
